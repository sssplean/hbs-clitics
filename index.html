<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enklitika Trener</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sentence-container" id="sentence"></div>
  <div class="enclitic-options" id="encliticOptions"></div>
  <div class="buttons">
    <button onclick="loadExample()">🔁 Novi primjer</button>
    <button onclick="checkAnswer()">✅ Gotovo</button>
  </div>
  <div id="feedback"></div>

  <script src="enclitics-data.js"></script>
  <script>
    let currentExample = {};
    let insertedMap = {}; // key: slot index, value: enclitic element

    function optionExists(text) {
      return Array.from(document.querySelectorAll('.enclitic-option'))
        .some(opt => opt.textContent === text);
    }

    function createOption(text) {
      if (optionExists(text)) return;
      const opt = document.createElement('div');
      opt.className = 'enclitic-option';
      opt.textContent = text;
      opt.draggable = true;
      opt.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', text);
        e.dataTransfer.setData('source', 'bank');
      });
      document.getElementById('encliticOptions').appendChild(opt);
    }

    function loadExample() {
      insertedMap = {};
      const sentence = document.getElementById('sentence');
      const encliticOptions = document.getElementById('encliticOptions');
      const feedback = document.getElementById('feedback');
      sentence.innerHTML = '';
      encliticOptions.innerHTML = '';
      feedback.textContent = '';

      currentExample = encliticsExamples[Math.floor(Math.random() * encliticsExamples.length)];

      currentExample.parts.forEach((word, i) => {
        const wordBlock = document.createElement('div');
        wordBlock.className = 'word-block';
        wordBlock.textContent = word;
        sentence.appendChild(wordBlock);

        const dropSlot = createDropSlot(i + 1);
        sentence.appendChild(dropSlot);
      });

      // Extra slot after last word
      const lastSlot = createDropSlot(currentExample.parts.length + 1);
      sentence.appendChild(lastSlot);

      // Create draggable enclitics
      const allOptions = [...currentExample.enclitics, ...currentExample.distractors].sort(() => Math.random() - 0.5);
      allOptions.forEach(text => createOption(text));

      // Allow dropping enclitics back to bank
      encliticOptions.ondragover = e => e.preventDefault();
      encliticOptions.ondrop = e => {
        e.preventDefault();
        const enclitic = e.dataTransfer.getData('text/plain');
        const source = e.dataTransfer.getData('source');
        const from = e.dataTransfer.getData('from');

        if (source === 'slot') {
          const fromSlot = document.querySelector(`.drop-slot[data-index='${from}']`);
          if (fromSlot && fromSlot.firstChild) {
            fromSlot.firstChild.remove();
            delete insertedMap[from];
          }
          createOption(enclitic);
        }
      };
    }

    function createDropSlot(index) {
      const dropSlot = document.createElement('div');
      dropSlot.className = 'drop-slot';
      dropSlot.dataset.index = index;

      dropSlot.addEventListener('dragover', e => {
        e.preventDefault();
        dropSlot.classList.add('over');
      });

      dropSlot.addEventListener('dragleave', () => {
        dropSlot.classList.remove('over');
      });

      dropSlot.addEventListener('drop', e => {
        e.preventDefault();
        dropSlot.classList.remove('over');
        const enclitic = e.dataTransfer.getData('text/plain');
        const source = e.dataTransfer.getData('source');
        const from = e.dataTransfer.getData('from');

        // If dragging from another slot, clear that slot
        if (source === 'slot') {
          const fromSlot = document.querySelector(`.drop-slot[data-index='${from}']`);
          if (fromSlot && fromSlot.firstChild) {
            fromSlot.firstChild.remove();
            delete insertedMap[from];
          }
        }

        // Remove same enclitic from other slots
        for (const idx in insertedMap) {
          const el = insertedMap[idx];
          if (el.textContent === enclitic) {
            el.remove();
            delete insertedMap[idx];
          }
        }

        // If slot already has enclitic, return it to bank
        if (dropSlot.firstChild) {
          const old = dropSlot.firstChild;
          createOption(old.textContent);
          old.remove();
          delete insertedMap[index];
        }

        const enclEl = document.createElement('div');
        enclEl.className = 'inserted-enclitic';
        enclEl.textContent = enclitic;
        enclEl.draggable = true;

        enclEl.addEventListener('dragstart', ev => {
          ev.dataTransfer.setData('text/plain', enclitic);
          ev.dataTransfer.setData('source', 'slot');
          ev.dataTransfer.setData('from', index);
        });

        enclEl.addEventListener('dblclick', () => {
          enclEl.remove();
          delete insertedMap[index];
          createOption(enclitic);
        });

        dropSlot.appendChild(enclEl);
        insertedMap[index] = enclEl;

        // Remove from bank if source is bank
        if (source === 'bank') {
          const options = document.querySelectorAll('.enclitic-option');
          options.forEach(opt => {
            if (opt.textContent === enclitic) opt.remove();
          });
        }
      });

      return dropSlot;
    }

    function checkAnswer() {
      const feedback = document.getElementById('feedback');
      const insertedIndexes = Object.keys(insertedMap).map(k => parseInt(k)).sort((a, b) => a - b);
      const expectedIndexes = currentExample.correctIndexes.sort((a, b) => a - b);
      const insertedEnclitics = insertedIndexes.map(i => insertedMap[i].textContent);
      const isCorrect = JSON.stringify(insertedIndexes) === JSON.stringify(expectedIndexes)
                     && JSON.stringify(insertedEnclitics) === JSON.stringify(currentExample.enclitics);

      // Highlight result
      for (const i in insertedMap) {
        const el = insertedMap[i];
        el.classList.remove('correct', 'incorrect');
        if (currentExample.correctIndexes.includes(parseInt(i)) && currentExample.enclitics.includes(el.textContent)) {
          el.classList.add('correct');
        } else {
          el.classList.add('incorrect');
        }
      }

      feedback.textContent = isCorrect ? '✅ Tačno!' : '❌ Nije tačno.';
      feedback.style.color = isCorrect ? 'green' : 'red';
    }

    document.addEventListener('DOMContentLoaded', loadExample);
  </script>
</body>
</html>
